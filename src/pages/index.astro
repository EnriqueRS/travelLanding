---
import Layout from "../layouts/Layout.astro"
import Countdown from "../components/Countdown.tsx"
import TripMap from "../components/Map.tsx"
import FlightInfo from "../components/FlightInfo.astro"
import CityCarousel from "../components/CityCarousel.tsx"
import Itinerary from "../components/Itinerary.astro"
import Expenses from "../components/Expenses.astro"
import ExpensesToggle from "../components/ExpensesToggle.tsx"
import { getTravelConfig } from "../lib/config"

const config = await getTravelConfig()
const cfg = config as any
const tripStartISO = cfg.trip?.startISO ?? "2026-01-01T00:00:00+02:00"
const heroLogo = cfg.site?.logo || null

// Ensure coords are passed as a fixed tuple type [lat, lng] which the
// TripMap component expects. This converts the generic JSON arrays into
// proper tuples and preserves other hotel properties.
// Prefer to derive hotels from `expenses.items` (category == 'Hoteles').
// Fallback to older `cfg.hotels` if no hotel items are present.
const hotelItems =
  cfg.expenses && Array.isArray(cfg.expenses.items)
    ? cfg.expenses.items.filter((it: any) => it.category === "Hoteles")
    : []
const rawHotels = hotelItems.length ? hotelItems : cfg.hotels || []
const hotelsForMap = (rawHotels || []).map((h: any) => ({
  name: h.name,
  coords: [h.coords[0], h.coords[1]] as [number, number],
  // keep `quality` if present (Map component will prefer it), else allow
  // older `stars` field for backward compatibility
  quality: h.quality ?? h.stars,
}))

// Similarly coerce stops into the expected tuple form and pass to TripMap.
const stopsForMap = (cfg.stops || []).map((s: any) => ({
  name: s.name ?? null,
  coords: [s.coords[0], s.coords[1]] as [number, number],
}))

const bgConfig = cfg.interactiveBackground || {}
const mapConfig = cfg.map || {}
const cities = cfg.cities || []
const defaultBanner =
  cfg.site?.defaultBanner || cfg.defaultBanner || "/banner_default.png"
---

<Layout
  title={cfg.site?.title ?? "Travel Landing Page"}
  description={cfg.site?.subtitle ?? "Itinerario, vuelos y más"}
  lang="es"
  themeConfig={bgConfig}
  siteConfig={cfg.site}
>
  <header class="container mx-auto px-4 py-4">
    <!-- Top row: logo (left) and nav controls (right). On small screens the title is shown below. -->
    <div class="flex items-center justify-between gap-4">
      <a href={cfg.site?.blog?.url ?? "#"} class="flex items-center gap-3">
        {
          cfg.site?.blog?.logo ? (
            <img
              alt={cfg.site?.blog?.name ?? "Blog"}
              src={cfg.site?.blog?.logo}
              class="h-12 w-auto rounded-xl object-cover bg-white/5 ring-1 ring-white/10 shadow"
              loading="lazy"
            />
          ) : null
        }
      </a>

      <nav class="flex items-center gap-3">
        <!-- <ThemeToggle client:load /> -->
        <ExpensesToggle client:load />
      </nav>
    </div>
  </header>

  <main>
    <!-- Hero -->
    <section class="container mx-auto px-4 pt-8 pb-12">
      <div class="grid md:grid-cols-1 gap-8 items-center">
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            {
              heroLogo ? (
                <div class="h-14 w-14 rounded-2xl overflow-hidden bg-white/5 ring-1 ring-white/10 shadow">
                  <img
                    src={heroLogo}
                    alt={cfg.site?.title ?? "Logo"}
                    class="h-full w-full object-cover"
                    loading="lazy"
                    onerror="this.parentElement && this.parentElement.remove()"
                  />
                </div>
              ) : null
            }
            <h1
              class="text-4xl sm:text-6xl lg:text-7xl font-bold tracking-tight leading-none"
            >
              <span
                class="bg-clip-text text-transparent bg-linear-to-r from-white via-rose-200 to-violet-200 drop-shadow-2xl"
              >
                {cfg.site?.title ?? "Travel Landing Page"}
              </span>
            </h1>
          </div>
          <p class="text-lg sm:text-2xl font-light max-w-3xl leading-relaxed">
            <span
              class="bg-clip-text text-transparent bg-linear-to-r from-slate-200 via-slate-300 to-rose-200"
            >
              {
                cfg.site?.subtitle ??
                  "Explora los imprescindibles, consulta los vuelos, sigue el mapa y prepárate con la cuenta atrás."
              }
            </span>
          </p>
          <div class="flex flex-wrap gap-4 items-center">
            <Countdown
              client:visible
              targetISO={tripStartISO}
              label="Despegamos en"
            />
            <a
              href="#itinerario"
              class="inline-flex items-center gap-2 rounded-md bg-rose-600 text-white px-4 py-2 hover:bg-rose-700 transition-colors"
              >Ver itinerario</a
            >
            <a
              href="#mapa"
              class="inline-flex items-center gap-2 rounded-md border border-white/10 px-4 py-2 bg-obsidian-800/60 hover:bg-obsidian-800/80 backdrop-blur-md transition-colors"
              >Ver mapa</a
            >
          </div>
        </div>
      </div>
    </section>

    <!-- Carousel de fotos de ciudades -->
    <section class="container mx-auto px-4 py-8">
      <CityCarousel
        client:only="react"
        cities={cities}
        defaultBanner={defaultBanner}
      />
    </section>

    <Expenses expensesData={cfg.expenses} />
    <FlightInfo
      flights={cfg.flights}
      airlineLogos={new Map(Object.entries(cfg.airlineLogos || {}))}
    />
    <div class="text-center">
      <a
        href={cfg.site?.blog?.url ?? "#"}
        target="_blank"
        rel="noreferrer"
        class="inline-flex items-center gap-3 rounded-lg px-4 py-2 border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
      >
        {
          cfg.site?.blog?.logo ? (
            <img
              alt={cfg.site?.blog?.name ?? "Blog"}
              src={cfg.site?.blog?.logo}
              class="h-8 w-auto rounded-lg object-cover"
              loading="lazy"
            />
          ) : null
        }
        <span>{cfg.site?.blog?.name ?? "Blog del viaje"}</span>
      </a>
    </div>
    <Itinerary itinerary={cfg.itinerary} cityImages={cfg.cityImages} />

    <section id="mapa" class="container mx-auto px-4 py-12">
      <h2 class="text-2xl sm:text-3xl font-semibold mb-6">Mapa del viaje</h2>
      <div class="relative group">
        <div
          class="absolute -inset-0.5 bg-linear-to-r from-rose-500 to-violet-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-500"
        >
        </div>
        <div
          class="relative rounded-2xl overflow-hidden border border-white/10 bg-obsidian-900"
        >
          <TripMap
            client:only="react"
            hotels={hotelsForMap}
            stops={stopsForMap}
            mapConfig={mapConfig}
          />
        </div>
      </div>
      <p class="mt-3 text-sm opacity-70">
        La ruta muestra los principales puntos y conexiones previstas.
      </p>
    </section>

    <section class="container mx-auto px-4 py-12">
      <h2 class="text-2xl sm:text-3xl font-semibold mb-6">Consejos útiles</h2>
      <ul class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          Tarjeta eSIM internacional para datos
        </li>
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          VPN fiable para apps occidentales
        </li>
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          Contrata un seguro médico para imprevistos.
        </li>
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          Traductor offline y mapas sin conexión
        </li>
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          Adaptores de corriente compatibles
        </li>
        <li
          class="rounded-xl border border-slate-200 dark:border-slate-800 p-4"
        >
          Efectivo para pequeños comercios
        </li>
      </ul>
    </section>
  </main>

  <footer class="container mx-auto px-4 py-10 text-sm opacity-80">
    <p>
      © 2026 Travel Landing Page
      {
        cfg.site?.blog?.url ? (
          <>
            {" "}
            — Inspired by{" "}
            <a
              class="underline underline-offset-4"
              href={cfg.site?.blog?.url}
              target="_blank"
              rel="noreferrer"
            >
              {cfg.site?.blog?.name ?? cfg.site?.blog?.url}
            </a>
          </>
        ) : null
      }
    </p>
  </footer>
</Layout>
