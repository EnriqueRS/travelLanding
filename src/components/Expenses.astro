---
import DonutChart from "./DonutChart.tsx"
import { StyledEngineProvider } from "@mui/material/styles"

const expenses = [
  {
    name: "Vuelo (Málaga - Pekín)",
    category: "Vuelos",
    amountEUR: 576.49,
    status: "CONFIRMED",
    city: null,
  },
  {
    name: "Vuelo (Shanghái - Málaga)",
    category: "Vuelos",
    amountEUR: 242.63,
    status: "CONFIRMED",
    city: null,
  },
  {
    name: "Campanile Xi'an Bell Tower Huimin Street (Xi'an)",
    category: "Hoteles",
    amountEUR: 17,
    status: "CANCELABLE",
    note: "03/04/2026",
    city: "Xi'an",
  },
  {
    name: "Radisson Blu Plaza (Chongqing)",
    category: "Hoteles",
    amountEUR: 106,
    status: "CANCELABLE",
    note: "04/04 → 07/04",
    city: "Chongqing",
  },
  {
    name: "Novotel Atlantis (Shanghái)",
    category: "Hoteles",
    amountEUR: 94,
    status: "CANCELABLE",
    note: "07/04 → 09/04",
    city: "Shanghái",
  },
  {
    name: "Howard Johnson Paragon",
    category: "Hoteles",
    amountEUR: 150,
    status: "CANCELABLE",
    note: "30/03 → 03/04",
    city: "Pekín",
  },
]
const total = expenses.reduce((acc, e) => acc + e.amountEUR, 0)
const budget = 2000
const percentage = Math.min((total / budget) * 100, 100)
const remaining = Math.max(budget - total, 0)
const formatEUR = (amount: number) => {
  // Treat values that are extremely close to integers as integers to avoid
  // showing unwanted decimals due to floating point math (e.g. 17.00000000002).
  const isWhole = Math.abs(amount - Math.round(amount)) < 1e-9
  return new Intl.NumberFormat("es-ES", {
    style: "currency",
    currency: "EUR",
    minimumFractionDigits: isWhole ? 0 : 2,
    maximumFractionDigits: isWhole ? 0 : 2,
  }).format(amount)
}
const percentageLabel = percentage.toFixed(1)
const showPercentageInside = percentage > 10
const remainingClass =
  percentage < 50
    ? "text-emerald-600 dark:text-emerald-400"
    : percentage < 80
      ? "text-amber-600 dark:text-amber-400"
      : "text-rose-500 dark:text-rose-400"
const categoryPalette = [
  {
    name: "Vuelos",
    description: "Billetes de avión y tasas",
    color: "#0ea5e9",
  },
  {
    name: "Transporte",
    description: "Trenes, taxis, traslados",
    color: "#22c55e",
  },
  {
    name: "Hoteles",
    description: "Alojamientos",
    color: "#facc15",
  },
  {
    name: "Seguro",
    description: "Coberturas médicas y de viaje",
    color: "#f97316",
  },
  {
    name: "Experiencias",
    description: "Entradas, visitas guiadas, parques de atracciones",
    color: "#ef4444",
  },
]
const categoryLookup = new Map(categoryPalette.map((cat) => [cat.name, cat]))
const categoryStats = categoryPalette.map((cat) => {
  const items = expenses.filter((item) => item.category === cat.name)
  const totalByCategory = items.reduce((acc, item) => acc + item.amountEUR, 0)
  return { ...cat, total: totalByCategory, items }
})
const categoryDistribution = categoryStats.filter((cat) => cat.total > 0)
const fallbackFillColor =
  percentage < 50 ? "#10b981" : percentage < 80 ? "#f59e0b" : "#ef4444"
const progressGradientStops = (() => {
  if (!total || !categoryDistribution.length) return ""
  let cumulative = 0
  return categoryDistribution
    .map((cat) => {
      const share = (cat.total / total) * 100
      const start = cumulative
      cumulative += share
      const startPct = Number.isFinite(start) ? start.toFixed(2) : "0"
      const endPct = Number.isFinite(cumulative) ? cumulative.toFixed(2) : "0"
      return `${cat.color} ${startPct}%, ${cat.color} ${endPct}%`
    })
    .join(", ")
})()
const progressStyle =
  percentage > 0
    ? categoryDistribution.length
      ? `width: ${percentage}%; background-image: linear-gradient(90deg, ${progressGradientStops}); background-color: ${fallbackFillColor};`
      : `width: ${percentage}%; background-color: ${fallbackFillColor};`
    : "width: 0%;"
---

<section id="expenses" class="container mx-auto px-4 py-12 hidden">
  <h2 class="text-2xl sm:text-3xl font-semibold mb-6">Gastos del viaje</h2>

  <!-- Barra de progreso del presupuesto -->
  <div
    class="mb-6 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 bg-white/60 dark:bg-slate-900/60 backdrop-blur shadow"
  >
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-sm opacity-70">Presupuesto por persona</div>
        <div class="text-2xl sm:text-3xl font-bold mt-1">
          {formatEUR(total)} / {formatEUR(budget)}
        </div>
      </div>
      <div class="text-right">
        <div class="text-sm opacity-70">Restante</div>
        <div class={`text-xl sm:text-2xl font-semibold mt-1 ${remainingClass}`}>
          {formatEUR(remaining)}
        </div>
      </div>
    </div>

    <!-- Barra de progreso -->
    <div
      class="relative h-6 rounded-full bg-slate-200 dark:bg-slate-800 overflow-hidden"
    >
      <div
        class="h-full rounded-full transition-all duration-500 ease-out flex items-center justify-end pr-2"
        style={progressStyle}
      >
        {
          showPercentageInside ? (
            <span class="text-xs font-semibold text-white">
              {percentageLabel}%
            </span>
          ) : null
        }
      </div>
      {
        !showPercentageInside ? (
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="text-xs font-semibold text-slate-600 dark:text-slate-400">
              {percentageLabel}%
            </span>
          </div>
        ) : null
      }
    </div>
  </div>

  <!-- Gráfico de distribución -->
  <div
    class="mb-10 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 bg-white/60 dark:bg-slate-900/60 backdrop-blur shadow"
  >
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6"
    >
      <div>
        <h3 class="text-lg font-semibold">Distribución por categorías</h3>
        <p class="text-sm opacity-70">
          Visualiza el peso de cada partida sobre el presupuesto total.
        </p>
      </div>
      <div class="text-sm font-medium text-slate-600 dark:text-slate-300">
        Total registrado: {formatEUR(total)}
      </div>
    </div>
    <div class="grid lg:grid-cols-[320px,1fr] gap-6 items-center">
      <div class="flex items-center justify-center">
        <StyledEngineProvider injectFirst>
          <DonutChart
            client:only="react"
            categories={categoryPalette}
            expenses={expenses}
          />
        </StyledEngineProvider>
      </div>
      <ul class="grid sm:grid-cols-2 gap-4">
        {
          categoryStats.map((cat) => {
            const hasItems = cat.items.length > 0
            return (
              <li class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 backdrop-blur">
                <details class="group rounded-xl" data-empty={!hasItems}>
                  <summary class="flex cursor-pointer items-center justify-between gap-3 px-4 py-3 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 rounded-t-xl">
                    <div class="flex items-center gap-3">
                      <span
                        class="h-3 w-3 rounded-full shadow"
                        style={`background: ${cat.color}`}
                      />
                      <div>
                        <h4 class="text-sm font-semibold">{cat.name}</h4>
                        <p class="text-xs opacity-70">{cat.description}</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="text-sm font-semibold">
                        {formatEUR(cat.total)}
                      </span>
                      {hasItems ? (
                        <span class="text-xs text-slate-500 dark:text-slate-400 transition-transform duration-200 group-open:rotate-180">
                          ▾
                        </span>
                      ) : null}
                    </div>
                  </summary>
                  {hasItems ? (
                    <ul class="px-4 pb-4 pt-1 space-y-2">
                      {cat.items.map((item) => (
                        <li class="rounded-lg border border-slate-100 dark:border-slate-800/60 bg-white/70 dark:bg-slate-900/60 px-3 py-2">
                          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <span class="text-sm font-medium">{item.name}</span>
                            <div class="flex flex-wrap items-center gap-3 text-xs sm:text-sm">
                              {item.note ? (
                                <span class="opacity-70">{item.note}</span>
                              ) : null}
                              <span class="font-semibold">
                                {formatEUR(item.amountEUR)}
                              </span>
                            </div>
                          </div>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p class="px-4 pb-4 text-xs opacity-60">
                      Aún no hay gastos en esta categoría.
                    </p>
                  )}
                </details>
              </li>
            )
          })
        }
      </ul>
    </div>
  </div>

  <!-- Tarjetas de gastos -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {
      expenses.map((expense) => {
        const category = categoryLookup.get(expense.category)
        const baseColor = category?.color ?? "#64748b"
        const label = category?.name ?? expense.category
        return (
          <article class="rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-white/60 dark:bg-slate-900/60 backdrop-blur">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="font-medium">{expense.name}</h3>
                <span
                  class="mt-2 inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-xs font-semibold shadow-sm"
                  style={`background: ${baseColor}1A; color: ${baseColor}`}
                >
                  {label}
                </span>
              </div>
              {expense.status === "CONFIRMED" ? (
                <span class="text-xs rounded-full px-2 py-0.5 bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200">
                  Confirmado
                </span>
              ) : expense.status === "CANCELABLE" ? (
                <span class="text-xs rounded-full px-2 py-0.5 bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200">
                  Cancelable
                </span>
              ) : null}
            </div>
            <div class="mt-3 text-xl font-semibold">
              {formatEUR(expense.amountEUR)}
            </div>
          </article>
        )
      })
    }
  </div>

  <p class="mt-6 text-sm opacity-70">
    Próximamente: hoteles, transportes, entradas…
  </p>
</section>
